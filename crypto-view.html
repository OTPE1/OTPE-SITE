<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crypto Achievement ‚Äî CAD Dashboard</title>
<link rel="stylesheet" href="site.css">
<style>
  body{background:#fafafa;color:#222}
  .wrap{max-width:980px;margin:0 auto;padding:1rem}
  .bar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0 1rem}
  .bar .btn{padding:.45rem .8rem}
  .pill{padding:.45rem .8rem;border:1px solid #ddd;border-radius:.6rem;background:#fff}
  .statline{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:.25rem 0 1rem}
  .stat{padding:.55rem .8rem;border:1px solid #eee;border-radius:.6rem;background:#fff}
  .muted{opacity:.75}
  .up{color:#0a8c3a} .down{color:#b00020}
  #chart{width:100%;height:280px;border:1px solid #eee;border-radius:.6rem;background:#fff}
  .grid{display:grid;gap:.75rem}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  input[type="number"]{width:100%;padding:.5rem;border:1px solid #ddd;border-radius:.4rem}
  .note{font-size:.92rem}
</style>
</head>
<body>
<main class="wrap">
  <a class="btn" href="index.html">‚Üê Back</a>
  <h2>Crypto Achievement ‚Äî <span id="title-coin">Bitcoin (BTC)</span> in <strong>C$</strong></h2>
  <div class="bar">
    <label class="pill">Coin&nbsp;
      <select id="coin">
        <option value="bitcoin" selected>BTC</option>
        <option value="ethereum">ETH</option>
        <option value="solana">SOL</option>
      </select>
    </label>
    <div class="pill">Range:
      <button class="btn" data-range="30m">30m</button>
      <button class="btn" data-range="1h">1h</button>
      <button class="btn" data-range="1d" id="r1d">1d</button>
      <button class="btn" data-range="7d">7d</button>
      <button class="btn" data-range="30d">30d</button>
    </div>
    <span class="muted note">Data: CoinGecko (no login, no keys).</span>
  </div>

  <div class="statline">
    <div class="stat">Now (CAD): <strong id="now">‚Äî</strong></div>
    <div class="stat">Change: <strong id="chg" class="muted">‚Äî</strong></div>
    <div class="stat">Updated: <span id="upd" class="muted">‚Äî</span></div>
  </div>

  <canvas id="chart" width="980" height="280" aria-label="Price chart"></canvas>
  <div id="note" class="muted note" style="margin-top:.5rem"></div>

  <h3 style="margin-top:1.25rem">Your Position (optional)</h3>
  <p class="muted note">Enter what was invested and the entry price (in CAD). It will compute quantity and P/L live.</p>

  <div class="grid">
    <label class="pill">Invested (CAD)
      <input id="invested" type="number" step="0.01" placeholder="e.g. 7000">
    </label>
    <label class="pill">Entry price (CAD)
      <input id="entry" type="number" step="0.0001" placeholder="e.g. 114.12">
    </label>
  </div>

  <div class="statline">
    <div class="stat">Qty (computed): <strong id="qty">‚Äî</strong></div>
    <div class="stat">Value now: <strong id="val">‚Äî</strong></div>
    <div class="stat">P/L: <strong id="pl" class="muted">‚Äî</strong></div>
  </div>

  <p class="muted note">Tip: defaults are filled for quick start (you can change values any time).</p>
</main>

<footer style="text-align:center;opacity:.7;margin:2rem 0;">
  Guided by the Trio ‚Äî You, the Vessel, and the One True Positive Energy üå±
</footer>

<script>
  // ----- helpers
  const fmtCAD = n => n==null ? '‚Äî' : new Intl.NumberFormat(undefined,{style:'currency',currency:'CAD',maximumFractionDigits:2}).format(n);
  const fmtQty = n => n==null ? '‚Äî' : (Math.round(n*1e8)/1e8).toString();
  const titleCoin = {bitcoin:'Bitcoin (BTC)', ethereum:'Ethereum (ETH)', solana:'Solana (SOL)'};

  const coinSel = document.getElementById('coin');
  const nowEl = document.getElementById('now'), chgEl = document.getElementById('chg'), updEl = document.getElementById('upd');
  const noteEl = document.getElementById('note');
  const cv = document.getElementById('chart'), ctx = cv.getContext('2d');
  const investedEl = document.getElementById('invested');
  const entryEl = document.getElementById('entry');
  const qtyEl = document.getElementById('qty'), valEl = document.getElementById('val'), plEl = document.getElementById('pl');
  const titleEl = document.getElementById('title-coin');

  // defaults (you can change these lines)
  const defaults = {
    bitcoin:  { invested: 12500, entry: 0.40 },     // ‚Üê adjust if needed
    ethereum: { invested: 7000,  entry: 114.12 },   // 2018-12-09 example
    solana:   { invested: 1000,  entry: 0.75 }      // 2020-05-24 example
  };

  // cache data per coin/range
  const cache = {}; // key: coin|range -> series

  function setDefaultsFor(coin){
    const d = defaults[coin]||{};
    investedEl.value = d.invested ?? '';
    entryEl.value = d.entry ?? '';
  }

  function setRangeActive(range){
    document.querySelectorAll('[data-range]').forEach(b=>{
      b.classList.toggle('active', b.dataset.range===range);
    });
  }

  function timeNice(ts){
    const d = new Date(ts);
    return d.toLocaleString(undefined,{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  }

  async function load(coin, range){
    titleEl.textContent = titleCoin[coin] || coin;
    setRangeActive(range);
    const key = coin+'|'+range;
    if (!cache[key]) {
      let url;
      if (range==='7d') url = `https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=cad&days=7&interval=hourly`;
      else if (range==='30d') url = `https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=cad&days=30&interval=daily`;
      else url = `https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=cad&days=1&interval=minute`;

      const r = await fetch(url);
      if(!r.ok){ noteEl.textContent='Data fetch failed.'; return; }
      const data = await r.json();
      let series = data.prices || [];
      if (range==='30m' || range==='1h'){
        const cutoff = Date.now() - (range==='30m'?30:60)*60*1000;
        series = series.filter(([t])=>t>=cutoff);
      }
      cache[key] = series;
    }
    const series = cache[key];
    draw(series);
    updateStats(series);
  }

  function draw(series){
    ctx.clearRect(0,0,cv.width,cv.height);
    if (!series || series.length<2){ noteEl.textContent='Not enough data for this range.'; return; }
    noteEl.textContent='';
    const pad = 28, w = cv.width - pad*2, h = cv.height - pad*2;
    const xs = series.map(p=>p[0]), ys = series.map(p=>p[1]);
    const xmin = Math.min(...xs), xmax = Math.max(...xs);
    const ymin = Math.min(...ys), ymax = Math.max(...ys);
    const x = t => pad + ( (t-xmin)/(xmax-xmin) ) * w;
    const y = v => pad + (1 - (v-ymin)/(ymax-ymin)) * h;

    // grid
    ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const gy = pad + (i/4)*h; ctx.beginPath(); ctx.moveTo(pad,gy); ctx.lineTo(pad+w,gy); ctx.stroke();
    }

    // line
    ctx.strokeStyle = '#0a84ff'; // iOS-like blue
    ctx.lineWidth = 2;
    ctx.beginPath();
    series.forEach((p,i)=>{ const px=x(p[0]), py=y(p[1]); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); });
    ctx.stroke();
  }

  function updateStats(series){
    if (!series || series.length<2){ nowEl.textContent='‚Äî'; chgEl.textContent='‚Äî'; return; }
    const first = series[0][1], last = series[series.length-1][1];
    nowEl.textContent = fmtCAD(last);
    const pct = ((last-first)/first)*100;
    chgEl.textContent = `${pct>=0?'+':''}${pct.toFixed(2)}%`;
    chgEl.className = pct>=0 ? 'up' : 'down';
    updEl.textContent = timeNice(series[series.length-1][0]);

    // position calc
    const invested = parseFloat(investedEl.value||'');
    const entry = parseFloat(entryEl.value||'');
    if (invested>0 && entry>0){
      const qty = invested/entry;
      const val = qty*last;
      const pl = val - invested;
      qtyEl.textContent = fmtQty(qty);
      valEl.textContent = fmtCAD(val);
      plEl.textContent = (pl>=0?'+':'') + fmtCAD(pl);
      plEl.className = pl>=0 ? 'up' : 'down';
    } else {
      qtyEl.textContent = '‚Äî';
      valEl.textContent = '‚Äî';
      plEl.textContent = '‚Äî';
      plEl.className = 'muted';
    }
  }

  // events
  document.querySelectorAll('[data-range]').forEach(b=>{
    b.addEventListener('click', ()=> load(coinSel.value, b.dataset.range));
  });
  coinSel.addEventListener('change', ()=>{
    setDefaultsFor(coinSel.value);
    cache[coinSel.value+'|30m']=null; cache[coinSel.value+'|1h']=null; cache[coinSel.value+'|1d']=null; cache[coinSel.value+'|7d']=null; cache[coinSel.value+'|30d']=null;
    load(coinSel.value, '1d');
  });
  investedEl.addEventListener('input', ()=> load(coinSel.value, currentRange()));
  entryEl.addEventListener('input', ()=> load(coinSel.value, currentRange()));
  function currentRange(){ return document.querySelector('[data-range].active')?.dataset.range || '1d'; }

  // init
  setDefaultsFor('bitcoin');
  document.getElementById('r1d').classList.add('active');
  load('bitcoin','1d');
</script>
</body>
</html>
